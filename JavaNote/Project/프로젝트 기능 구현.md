# 내가 한 작업
- 호스트 예약관리 페이지
  - 승인 대기 예약 내역 출력, 승인 거절 선택 버튼
  - 승인된 예약 출력

- 호스트 숙소 등록 페이지 제작
  - (1페이지)
  - 숙소 타입 선택 버튼
  - 숙소 위치 설정하는 지도 api
  - 숙소 기본 정보 개수 설정 칸
  - 숙소 편의시설 정보 선택 버튼
  - 사진 추가
  - 숙소 설명 입력 폼
  
  - (2페이지)
  - 요금설정 입력 폼
  - 본인인증 api

- 호스트 모드 헤더 생성

- 숙소관리 페이지
  - 등록한 숙소 출력
  - 상태 변경 기능
  - 숙소 추가 버튼 -> 숙소 신청 페이지로 이동

- 정산 페이지
  - 등록된 숙소 정보
  - 전체 수입, 이번달 수입 출력
  - 숙소 탭 클릭 시 상세 내역 팝업

- 게스트와 채팅
  - 서버 방식

# 1일차(2024-04-01)
- 기능별 파트 분담
- git branch 사용법 학습
- log4j 일자별 로그파일 출력 설정 방법 학습

# 2일차(2024-04-02)
- 호스트 예약관리 페이지 제작
  - HostReservation: VO 객체 생성
  - HostReservationController: list와 stateUpdate 메서드 작성
  - HostReservationService: 서비스 인터페이스 정의
  - DefaultHostReservation: 값을 받아 Dao 호출
  - HostReservationDao: Dao 인터페이스
  - HostReservationDao.xml: Mybatis로 Dao 구현체 생성, ResultMap을 사용하여 hostReservation 객체로 데이터를 받아옴
  - templates/hostReservation/list.html: 예약관리 화면, DB에서 상태를 조건으로 따로 select하지 않아 Thymeleaf의 조건문(data-th-if)으로 화면에 렌더링하는 값을 제어함

- 문제
  - 예약관리 페이지 요청 시 호스트의 회원번호가 가진 숙소 예약 리스트를 모두 출력해야 하는데, 기존 sql에서는 예약한 사용자의 회원번호가 where로 들어가 제대로 출력되지 않음  
  => mybatis의 sql 문 수정

  - 예약 승인/거절 update를 할 때 Post요청을 할지 Get요청을 할지 헷갈림  
  => Post 요청이 맞다고 판단, form 태그+input의 hidden으로 파라미터를 보내서 해결

# 3일차(2024-04-03)
- 호스트 전용 헤더 작성

- 호스트 숙소 등록 페이지 작성
  - 프론트 html 간단한 자바스크립트에 한해서만 구현
    - ex) 요금에 따른 정산금액 실시간 출력
  - dao, controller, service 토대만 완성

- HostReservation 페이지 컨트롤러를 HostController로 변경, 관련 페이지 컨트롤러를 통합
  - Host관련 기능을 하나의 페이지 컨트롤러로 관리하는게 더 유지보수하기 좋다고 생각함
  - 그에 맞춰서 매핑도 수정해주었다.

# 4일차(2024-04-04)
- 호스트 숙소 등록 페이지 구조 변경 및 구현
  - 기본 정보, 테마, 시설에 따라 페이지를 나누고 입력받기
  - 숙소 테마 입력 받는 페이지 일부 구현

- 문제: 
  - <form> 안에 <form> 태그가 또 존재하면 <button>의 submit 기능이 비활성화된다..<button>은 <form> 태그 안에 유일하게 존재하면 그 button은 자동으로 submit 타입으로 지정된다.
  
  - redirect를 통해 다음 페이지로 이동했을 때 model에 들어있는 값이 아예 전달되지 않았음. 
  forward랑 달리 redirect는 지정된 주소로 새로운 Get 요청을 수행하기 때문에 실행 이전에 request, model 데이터가 전부 날아가버린다. 
  redirect로 값을 보내려면 RedirectAttribute 객체를 사용하거나, 그냥 mapping URL을 지정하여 화면을 이동하는 방법을 사용해야 한다. 

  => 피드백 후 session에 보관하기로 함


# 5일차(2024-04-05)
- 로고 제작

- 피드백
  - Object Storage를 적용해서 이미지가 보이도록 변경해야된다.
  - 호스트 예약관리에서 종료된 호스팅 리스트을 추가하고, 상태를 "예약 전/이용 중" 등 표시하게 한다.
  - 이미지 파일 다루는 코드에서 null 검사하지 말고 프론트에서 제한을 건다.
  - RentalHomeTheme vo를 통일을 위해 Theme으로 변경한다.
  - 이미지 최대 개수 제한 X, 최소는 제한 걸어야 한다.


# 7일차(2024-04-07)
- 숙소 등록 최종 확인 페이지 구현
- 기본정보, 시설, 테마를 session에 저장하여 페이지 이동, 등록 메서드에서 한번에 등록(진행중)
- 숙소 관리 페이지 구현
  - 숙소 정보 resultMap으로 한번에 가져와 출력(완)


- 문제
  - Mybatis를 통해 값을 온전히 session에 담아 보냈는데 rentalHomeConfirm에서 반복문으로 출력하고 등록 메서드로 보냈을 때 String에 하나의 값이 담기지 않고 모든 값이 ,로 묶여 보내지는 문제가 발생.  

  JavaScript, html 모든 해결방법을 찾아본 결과, 컨트롤러에서 rentalHome에 값을 담아 세션으로 보낼 때 List<Integer>인 테마, 시설 값들을 for(int i = 0; ...) 반복문을 통해 get(i)하는 경우만 문제가 발생하지 않는다. 원인은 찾지 못한 상태... 테마 폼에서 사용하는 숙소 타입은 같은 테마지만 input type이 radio여서 themeNo와 themeName을 ","로 묶어서 보내고 split으로 분리하는 방식을 사용하였다. 


# 1주차 회고
DB모델링과 sql할 때까지는 추상적으로 설계했으므로 지금까지 배운 내용을 적용하는 간단한 문제라고 생각했다. 하지만 실제 구현을 하려고 보니 vo객체도 제각각 다르고 페이지를 이동하며 어떤 값이 전달되고 어떤 값을 받아야 하는지 고려하게 되었다(이 부분이 제일 중요).  

아직 처음이라 디버깅을 위한 로그를 찍는 방법부터, 효율적 설계까지는 아니어도 기본적인 구조를 적용하는데 필요한 기본지식이 완벽히 암기가 안된 상태여서 예상보다 속도도 많이 더딘 것 같다.  

HTML,Javascript,css를 배우기에 앞서 Mybatis, Thymeleaf, SpringBoot의 원리를 빨리 이해해야 할 것 같다.  

총평: 절대적 시간이 부족한 게 너무 아쉽다. 마음이 급할 수록 쉬어가라는 말이 있지만 나는 동의할 수 없다. 시간을 어떻게든 쪼개서 성장가능성을 보다 높이는 것이 내 목표다.


# 8일차(2024-04-08)
- hostDao를 각각 기능에 따라 FacilityDao, ThemeDao, PhotoDao로 분리
  - Dao별 필요한 기능(리스트 가져오기, 번호로 가져오기) 추가

- 번호로 RentalHome 정보를 가져오는 sql문 수정
  - 필요한 collection(Facilities, Themes)을 가져오는 join이 누락되어 있었음

- session.setAttribute를 @SessionAttribute 애노테이션 처리 방식으로 변경

- 숙소 상세/변경 페이지 구현(진행중)

- 문제
  - 숙소 상세 뷰 페이지에서 상태 표시를 할 때 `data-th-if="*{state == 0}"..` 이 Thymeleaf Parsing 에러가 발생
    => 값을 가져오는지 로그를 찍어보니 Dao의 리턴값이 null인 것을 확인, sql 쿼리문에 문제가 있었음. collection을 포함해 모든 값을 가져올 수 있도록 select문을 수정했다.

  - 테마리스트, 편의시설리스트를 가져온 후 RentalHome이 가지고 있는 리스트에 포함된 테마, 편의시설에는 체크박스 표시를 default로 설정하는 방법
  
  => Thymeleaf, html로는 해결 불가능하다고 판단.
  JavaScript를 찾아봄


# 9일차(2024-04-09)
- 숙소 상세 페이지 구현(진행중)
  - 업데이트 남음

- vo 객체 조정에 따른 Mybatis 수정
  - insert 하기 위해 시설, 테마, 숙소사진 vo에 숙소번호를 추가하고 리스트를 DAO 파라미터로 넘기는 방식이 비효율적이라고 생각하여 숙소 vo 객체 자체를 넘기는 방식으로 변경.
  -> ParameterMap을 사용하려고 했으나 Mybatis 공식문서에 더 이상 지원(권장)하는 방식이라고 해서 ParameterType으로 처리함

- 문제
  - 테마리스트와 객체에 들어있는 테마리스트의 번호를 비교하여 체크표시를 해야 되는 부분을 어떤 방식으로 처리해야 하는지

  => lombok의 equalsAndHashCode.exclude 애노테이션을 통해 반복되는 themeList의 theme 객체와 rentalHomeThemes를 indexOf 하는 방식?


# 10일차(2024-04-10)
- 숙소 등록 페이지 리팩토링
  - 숙소 등록 시 사진 파일을 선택하면 해당 사진이 동일한 사이즈로 optimizing되어 화면에 출력되는 기능 추가, 자바스크립트 사용

- 숙소 상세 페이지 구현(진행중)
  - 숙소 상세에서 기존 값을 모두 체크표시, 출력하도록 구현


# 11일차(2024-04-11)
- 숙소 등록 페이지 리팩토링
  - 사진마다 사진 설명을 입력받고 DB에 같이 추가하도록 수정
  - 사진 설명을 입력하지 않으면 기본값이 입력된다.(N.N)

- 숙소 상세 페이지 구현(진행중)
  - 업데이트를 위한 Service, Dao 생성()
  - 사진은 ncp의 Image optimizer를 사용하여 출력

- 문제
  - 숙소 상세 페이지의 업데이트 기능을 구현하려고 보니 기존 사진은 ncp의 Image Optimizer를 사용하여 출력하고 새로 입력받을 사진은 자바스크립트로 출력하기 때문에 한번에 다루기 힘든 문제가 발생한다. 

  파일을 자바스크립트에서 배열로 관리하는 방법을 사용 


# 12일차(2024-04-12)
- dev branch로 pull request 진행
  - pull request 후 push를 안해서 문제가 한번 발생했었음
  - pull request 하여 merge한 후 충돌이 있었던 파일을 삭제하거나 수정하여 다시 push하니까 다음 pull request에서는 문제 없이 merge가 잘됐다.

- 숙소 등록 페이지 리팩토링
  - 입력받은 파일을 filesArray 배열에 담아 따로 관리(진행중)
  - formData에 추가하여 fetch api로 전송(진행중)


# 13일차(2024-04-13)
- 숙소 등록 페이지 
  - 입력받은 파일을 filesArray 배열에 담아 따로 관리
  - formData에 추가하여 fetch api로 전송
  - 마지막 확인하는 페이지에도 사진과 설명이 출력되도록

- 문제 
  - fetch api로 form을 전송할 떄 form 태그 안에 있는 input값들은 formData에 존재하지 않아 보내지지 않음
  
  해결: 자바스크립트에 formData.append로 하나씩 추가해주는 방법 선택

  - 기존 코드로는 이미지 삭제 시, 사진 설명도 같이 삭제되야 하는데 삭제되지 않고 그대로 남음
  
  해결: filesArray에 객체형태로 사진과, 설명을 저장해두고
  form을 전송하는 submitForm 함수에서 객체배열을 순회하며 각각의 값을 저장하는 방식으로 해결

  - fetch api를 사용하면 응답을 받아야 함, 기능은 폼을 전송한 후 응답이 필요없고 redirect를 해야 함.
  어떤게 응답되는 건지?
  redirect가 왜 안먹히는지? 모르겠다.

  해결: 임시로 페이지 이동하는 url을 하드코딩.. 


# 14일차(2024-04-14)
- 숙소 상세 페이지
  - pull request 후 vo 변경에 따라 mybatis mapper 파일의 resultMap과 객체명 수정

  - 이전에 발생했던 문제(Object Storage로 출력하는 기존 사진과 새로 입력받는 사진의 형식이 다른)를 처리할 방법을 고민, 자바스크립에서 하나의 배열로 관리하려고 코드를 만들어보았으나 새로운 사진을 등록하고 기존 사진을 삭제하는데 있어 매우 복잡해지는 상황이 발생하여 철회하고 css 형식만 공유하고 각각의 파일은 따로 관리하기로 결정

  - Object Storage와 새로운 input 파일이 함께 출력되도록 css를 rentalHomeForm과 동일하게 변경

# 2주차 회고
1주차 회고때 언급한 것처럼, thymeleaf와 mybatis, mvc 구조를 보다 이해하기 위해 공식문서와 블로그를 찾아보며 최대한 내 코드를 머리 속에 깊이 이해하려고 노력했다. 이 구조를 이해하고 나니 vo객체를 어떻게 생성하고 어떤 코드부터 만들어야 할 지 설계하는 것이 보다 쉬웠다.  

새로이 직면한 문제는 자바스크립트와 api를 적용하는 부분이다. 어떤 코드를 구현할 때 자바스크립트로 만들지 아니면 타임리프를 사용할지 구분하는 것이 아직은 어색하다. 나아가 자바스크립트로 구현해야 하는 기능을 구현하는 데 필요한 기술을 찾아보는 시간과 구현하며 에러를 찾는 시간이 너무 오래 걸린다. 자바스크립트 문법을 잘 몰라서라기보다 특정 api를 사용하거나 자바스크립트를 사용했을 때 어떤 요청이 오고가는지 디버깅을 찍어보는 연습이 부족한 것 같다. 

혼자서 최대한 찾아본 후 강사님께 어떤 방식이 효율적인지 조언을 구해보자.

# 15일차(2024-04-15)
- 숙소 등록 페이지 리팩토링
  - 사진을 추가하는 함수에서 input 태그로부터 받은 files를 반복할 때 개별 파일에 대한 변수로 var이 아닌 let으로 변경  
  그러면 반복문을 돌 때 let 변수가 사라지고 클로저 함수에는 각각의 file이 복제되므로 굳이 익명함수를 정의하는 즉시 호출하는 형태를 사용할 필요가 없어 코드의 복잡성을 줄일 수 있다.
  - Fetch API로 리다이렉트하는 부분은 하드코딩(컨트롤러 리턴값은 @requestBody)

- hostController 메서드 추출
  - 사진, 테마, 시설과 같이 controller에서 받아 형태를 변환시켜주는 코드가 add와 update에서 중복되므로 이를 메서드로 추출하여 중복을 제거함

- 숙소 상세 페이지
  - 숙소 기본정보는 update
  - 시설, 테마는 수정 시 전체 삭제 후 다시 add
  - 사진은 delete 버튼 눌렀을 때 하나씩 삭제, 추가된 사진은 그대로 add

- 문제
  - 시설, 테마의 경우 중복 id를 지정할 수 없어서 getElementById() 또는 querySelector()로 값을 보낼 수가 없다.  
  -> querySelectorAll()의 경우 class를 기준으로 값을 모두 DOM 형태 가져온다. 필요한 값에 대해 id 대신 class를 지정하고(class css가 없어도 지정 가능) 가져온 DOM 리스트를 순회하여 formData에 추가해주는 방법 고려

  - thymeleaf는 html 수정 시 서버 재시작 안해도 변경이 적용되는데 정적 리소스는 변경이 안되는 것을 확인
  -> application.properties의 static 경로 설정에 오타.. spring.web.resources.static-location에 locations가 잘못되어 있었음
  바꾸는 김에 설정파일도 application-dev와 application-prod로 분리함

# 16일차(2024-04-16)
- 숙소 상세 페이지 형식 수정
  - 요금 자동 계산 기능 수정, 호스팅 시작일 변경불가 지정, 수용인원 추가

- 숙소 상세 페이지 컨트롤러 수정
  - 숙소 사진의 경우 기존 사진의 사진 순서를 반영하여 추가해야 하므로, 기존 파일리스트를 받아 마지막 순서를 객체변환 메서드에 파라미터로 넘겨줌

- 숙소 상세 페이지 업데이트 기능 완성
  - 자바스크립트, fetch api를 통해 숙소 정보 업데이트 하는 기능 완성

- 문제
  - 기존 사진에 대한 정보를 아예 주지 않았는데 넘어감
    -> 찾아보니 @sessionAttribute 애노테이션에 지정된 객체와 일치하는 필드를 request handler에서 같은 객체 파라미터로 받으면 자동 바인딩이 되어서 발생한 문제. 바인딩이 되기 전 sessionStatus.setComplete()로 임시 값을 제거해주면 해결된다.
  
  - querySelectorAll() 함수를 통해 class를 가져오면 선택되지 않은 값도 모두 폼데이터에 추가되는 문제
  -> 테마는 type의 형태가 테마번호와 테마이름이 ,로 묶인 형태이고 자바스크립트로 보내지는 값이 단일값이라 id를 통해 따로 폼데이터에 추가해주고 다중선택하는 querySelectorAll()로 모든 요소를 가져와 인덱스를 추가해 반복하여 checked 옵션이 있으면 해당 인덱스의 히든값도 같이 폼데이터에 추가함  
  시설의 경우 기본 시설은 개수로 받고 편의시설은 체크박스로 받기 때문에 querySelectorAll()로 가져온 요소 중 checked 옵션은 테마와 동일하게 폼데이터에 추가하고 기본 시설은 인덱스를 조건으로 걸어서 추가해줌(기본시설의 인덱스 0~2)


# 17일차(2024-04-17)
- 숙소 정산 페이지 구현(진행 중)
  - 숙소리스트와 이용건수 출력
  - 총 정산금액, 지난 한달 간 정산금액 출력

- 문제
  - 설정한 기간에 따라 출력되는 데이터가 다르다. 즉 기간으로 조회하려면 post, 탭을 눌러 처음 리스트로 진입할 때는 get으로 진입해야 하는 문제가 발생  
   -> 우선 기본 페이지는 get 요청을 받고 조회 버튼을 누를 시 post 요청을 받아서 redirect하는 방식으로 만들고 강사님께 여쭤보기로 함

  - 이번달 수입을 계산해서 출력해야됨
    -> LocalDate 객체의 isBefore(), isAfter()/isEquals()를 사용하여 기간 내에 결제일이 존재하면 income을 더해서 모델에 담아주는 형태로 만듦

  - 숙소별로 특정 기간동안 이용한 인원수를 계산해야 됨  
    -> 우선 이용인원수보다 이용건수를 저장하는 것이 좋아보임. 이용인원수 종합은 의미가 없다고 생각함. 
    -> 이용건수 계산은 HashMap을 사용, 숙소번호를 key 이용 건수를 value로 예약리스트의 객체가 가지고 있으므로 HashMap의 getOrDefault()를 통해 key가 없으면 0으로 초기화 하고 있으면 +1 해주는 방식.
    정해진 기간에 따라 이용건수가 출력되야 하므로 수입을 계산하는 코드(반복문/조건문)에 그대로 추가해주면 된다. 
    -> HashMap은 그대로 Model에 추가하여 사용, thymeleaf로 값을 사용할 때는 `${model 이름[키]}`로 사용, 만약 키값으로 thymeleaf 값을 넣고 싶다면 안에 들어갈 jtsl문을 "__"로 묶으면 타임리프문이 정상적으로 실행된어 값이 배치된다. ex) `${model 이름[__${model이름}__]}`


# 18일차(2024-04-18)
- 숙소 정산 페이지 구현
  - 백엔드로 처리하는 날짜 조회 기능 구현, default는 한달  
  -> post처리하려고 했으나 get 요청에 null값을 받는 경우와 date를 받는 경우 두 케이스로 구분해서 하나의 메서드로 처리함
   
  
- 문제
  - 숙소별 정산 상세를 표시할 때 숙소가 가진 예약리스트도 날짜 필터링을 해주어야 함.
  - 탭 클릭 시 해당 숙소의 예약내역 정보들을 출력하도록 해야 함.
  

# 19일차(2024-04-19)
- 숙소 정산 페이지 구현
  - 팀장님과 논의한 결과 상세 보기를 출력하고 날짜 조회하는 기능은 모두 자바스크립트로 구현해보기로 함
  - 숙소별 정산 상세 내역 출력(태그 추가 방식)
  - 숙소별 정산 상세 내역 숨기기(태그 제거 방식)

- 문제
  - 콘텐트 안에 <button> 태그를 만들고 부모 div와 크기를 맞춰 리스너를 걸려고 했으나, 강사님께서 시맨틱 태그 개념에 따라 <div> 태그에 리스너를 거는 것이 바람직하다고 하심.
  - <script src=""></script>, <script>..</script>는 같이 사용할 수 없다. 만약 링크로 스크립트를 가져오고 싶다면 태그 안에 내용을 작성하면 안된다.
  - 자바스크립트의 `${파라미터/변수}`와 타임리프의 ${모델명}은 서로 다른 문법이다.
  - 모델에 담겨진 객체 또는 값을 자바스크립트로 가져오는 방법... data-th-inline="javascript" 옵션을 `<script>` 태그에 추가해주면 바로 가져올 수 있다.
  - 마우스 클릭 시 이벤트에 대하여... 이벤트 단계는 capture phase와 bubble phase로 구분하고, 이벤트 객체의 target을 지정하면 target이 있는 그 태그가 
  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
  반환 아몰랑
  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
  
# 21일차(2024-04-21)
- 숙소 정산 페이지 구현(완)
  - 날짜조회 기능 추가
    - 자바스크립트로 구현, 조회 버튼을 누르면 결제일을 기준으로 기준 기간 사이에 있는 예약내역만 필터링하여 filteredReservationList 변수에 저장한 후 이용건수, 총수입을 업데이트한다.
    - 기존 상세 보기는 전역변수인 reservationList를 통해 태그를 생성하였지만 필터링된 데이터를 출력하기 위해 파라미터로 예약리스트를 받도록 한 후 filteredReservationList가 Null이 아닐 경우 필터링된 리스트를 파라미터로 넣어주었다. 총 수입, 이용건수 업데이트 하는 부분도 마찬가지, 굳이 값을 초기화할 필요없이 innerHTML을 해주면 기존 값이 대체된다.
    - 그 외로 구조적인 부분을 수정함. ex) 상세 보기 창을 띄운 상태에서 조회 시 기존 상세 보기 창을 제거
  
# 22일차(2024-04-22)
- 숙소 정산 페이지 리팩토링
  - 한번만 쓰는 자바스크립트 함수를 애로우 펑션으로 교체
  - 숙소 대표 이미지 렌더링

- 호스트 채팅 기능 구현(진행중)
  - SpringBoot WebSocket 사용
  - 우선 WebSocket이 어떻게 돌아가는지 확인하기 위해 블로그, 공식 docs들을 참고
  - WebSocket, SockJS, STOMP 순으로 채팅방 구현
    - WebSocket: 직접 WebSocket을 연결
    - SockJS: WebSocket을 지원하지 않는 브라우저에서 실행할 수 있도록 대체해줌
    - STOMP: sub/pub 과 같이 다루기 편한 구조로 채팅방을 구현할 수 있음
  - 예약번호를 채팅방번호로 사용하여 여러 채팅방 구현
  - 참고 블로그: https://dev-gorany.tistory.com/212

- 문제
  - STOMP에 대한 추가 학습 및 구조/원리 이해 필요
    - 채팅방 view에 필요 정보를 전달할 때 일반적인 model.addAttribute() 방식 사용 불가한 이유?
    - 예약내역을 채팅방으로 사용하고 있는데 채팅방을 따로 생성하는 과정이 필요한지?
    - 전송된 메시지를 어떻게 해야 파일 형태로 저장하고 불러올 수 있을지
    - 전송한 메시지가 화면에 출력되지 않는 문제 아직 해결 x

# 23일차(2024-04-23)
- 호스트 채팅 기능
  - 예약 내역을 기준으로 채팅리스트 뷰 페이지 구현
  - 채팅 기능을 Nodejs WebSocket으로 변경
    - 이후 추가될 기능들을 고려하면 STOMP를 적용한 SpringBoot WebSocket보다 Nodejs의 socket.io 프레임워크가 더 설계하기 편하다는 팀장님의 의견 수용
  - NodeJS 웹소켓 서버 생성 (Port:3000)
  - 웹소켓 서버는 클라이언트로부터 예약번호를 받아 해당 예약번호로 매핑된 채팅방ID가 없으면 채팅방을 생성, 있으면 기존 채팅방에 연결하고 메시지를 보낼 때 io.to(채팅방ID).emit으로 전송.  
  (메시지 전송 시 객체에 메시지 내용, 예약번호를 담아 전송 + 추후 유저명도 추가할 예정)
  
- 문제
  - 두 사용자가 접속 후 나중에 들어온 사람이 메시지를 보내도 화면에 출력되지 않는 문제, 먼저 들어온 사용자가 메시지를 보내면 이후 정상적으로 출력된다.
  해결 못함. socket.join()이 메시지를 보내는 이벤트에서 실행되기 때문인데, 그럼 예약번호를 어떻게 받아와야 하나?

  - 기존 채팅 내역을 저장하기 위해 ObjectStorage에 저장해야 함.
  - JSON 형식 데이터를 다루는 것이 어색함.

# 24일차(2024-04-24)
- 호스트 채팅 기능
  - nodejs와 spring boot 서버 간 url 경로 연결
  - nodejs socket.io 구조 다시 파악 후, 설계
    - 메시지는 객체형태로 전송(전송자이름, 내용, 시간)
    - 웹소켓에 접속 후 메시지를 전송하면 서버에서 객체 배열에 저장한 후 클라이언트에게 전송하도록 구현함
    - 클라이언트가 접속을 종료하면 object storage에 객체 배열을 파일로 변환하여 업로드하도록 만들 예정임.

- 문제
  - nodejs에서 선언된 변수가 어느 블록에서 어떤 생명주기를 갖는지 몰랐음  
    서버가 실행되는 동안 chat.js에 선언된 변수는 계속 유지, 블록 안에 있는 변수들은 함수 실행이 종료된 후에 제거됨  

    채팅방을 구분하는 식별자인 예약번호를 한번 저장해놓으면 새 메세지를 서버에서 수신하였을 때 재사용할 수 있다.

  - 사용자 정보는 접속 시 파라미터로 보내거나, 메시지를 보낼 때 같이 보낼 수 없는 구조이다. 사용자가 접속 시 입장 알림이 렌더링 되어야 하고, 파라미터로 보낼 시 url이 달라지기 때문이다.  

  SpringBoot에서 nodejs로 값을 보내기 위해 ajax를 활용함. ajax가 POST 요청을 보낸 컨트롤러에서 데이터를 Map 객체에 담고, RestTemplate을 사용해 nodejs 서버로 보낸 후 리턴하면 nodejs 서버 포트 경로로 redirect한다.  

  RestTemplate는 스프링 프레임워크에서 제공하는 클래스로 HTTP 통신을 간단하게 메서드 호출만으로 처리할 수 있도록 해준다.
  
  - 한 사용자가 접속을 종료하면 Object Storage에 객체 배열에 담긴 메시지 파일을 저장하고, 다시 들어왔을 때 그 파일을 읽어 기존 채팅 내역을 출력하는 방식일 경우에 발생할 수 있는 문제를 예를 들어보겠다.

  만약, 남아있는 사용자가 재접속 전까지 계속 메시지를 보내면 그 메시지 내용은  object Storage에 저장되지 않아 출력되지 않겠죠.. 더불어 서버가 종료되지 않는 한 메시지를 담은 객체 배열은 제거되지 않아 메모리 사용량이 점점 늘어날 것이어유

  현재 가능성이 있는 해결방법
  - 두 사용자가 모두 나갈 때 Object Storage에 저장하고 객체 배열을 초기화, 만약 객체 배열이 없다면 Object Storage에서 파일을 가져와 배열로 만든다!

  - 서버가 유지되는 동안에는 객체 배열에 담긴 메시지들도 제거되지 않고 계속 유지된다. 

# 25일차(2024-04-25)
- 호스트 채팅 기능
  - 구조 재변경
    - 객체 배열을 삭제하지 않고 메모리에서 계속 사용한다면 과부하가 걸릴 가능성이 매우 크다. 따라서 종료 시 배열은 삭제해주되 숙소 이용기간이 끝날 때까지 파일을 로컬에 보관하도록 하고, object storage에는 업로드만 한다. 
    추후에 쉘스크립트 배치를 사용하여 삭제 예약을 거는 로직도 구현해볼만 함.
  - object storage 업로드 구현
    - 사용가이드 예제 코드를 적절히 수정하여 적용함
      - Node.js 클래스를 정의하고 파일 업로드/삭제 함수를 작성
      - Chat.js 파일에서 인스턴스를 생성하여 사용
  - 파일 저장/변환, 경로 변환, 환경 변수 모듈 사용 (자세히 공부 X)
    - ex) fs, path, dotenv, bodyParser

- 문제
  - async, await 등 objectStorage에 사용된 문법을 몰라 읽는데 시간이 좀 걸림.
  - fs.readdir 사용 시 문제
    - 기존 파일을 읽어서 메시지 리스트에 저장했는데 값은 계속 하나밖에 안들어간다.  
    처음에는 읽어온 원시 텍스트 파일이 배열로 제대로 변환이 되지 않아 단일 객체여서 계속 덮어씌워지는 줄 알았으나 로그를 출력해보니 파일에 메시지를 push하는 것이 parse보다 더 먼저 실행이 되는 것을 확인했다. 찾아보니 fs.readdir() 함수는 비동기적으로 파일을 불러오기 때문에 push하고 파일을 저장하는 과정이 먼저 일어나서 발생한 문제이다..  
    따라서 파일이 존재하는지 여부를 동기적으로 확인하는 fs.existsSync() 함수로 수정해주었다.
- 예제 코드
```
socket.on('chat message', (data) => {
    console.log('수신한 메시지:', data);

    var messageList = [];

    var fileName = 'chat-'+ reservationNo +'.json';
    filePath = path.join(__dirname, 'tmp', fileName);

    fs.readdir('./tmp', (err, files) => {
      // 디렉토리 내에 파일이 있는지 확인
      if (err) {
        console.error('Error reading directory:', err);
        return;
      }

      if (files.includes(fileName)) {
        let fileContent = fs.readFileSync(filePath, 'utf8');
        messageList = JSON.parse(fileContent);
      }

    });


    // 객체로 만들어 메시지 배열에 담기
    const currentTime = new Date().toISOString().replace(/T/, ' ').replace(/\..+/, '');
    const message = {writer: loginUser, message: data.message, time: currentTime}
    messageList.push(message);
    console.log(messageList);

     메시지 배열을 JSON으로 변환하여 파일 작성
    fs.writeFileSync(filePath, JSON.stringify(messageList));


    // 채팅방에 메시지 전송
    io.to(reservationNo).emit('chat message', loginUser + ": " + data.message);
  });
```
- 남은 것
  - 페이지 및 헤더에 알림 띄우는 기능...
  - 생각해보니 배열도 나눠야 함.. 여러명이 하나의 메시지 배열을 사용하고 있음
  - 기존 채팅 내역 파일에서 읽어서 출력하기



